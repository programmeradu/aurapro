#!/usr/bin/env python3
"""
üîß COMPREHENSIVE BACKEND TESTING SCRIPT
Test all backend modules, dependencies, and functionality
"""

import sys
import os
import traceback
from datetime import datetime

# Add backend to path
sys.path.append('backend')

def test_basic_imports():
    """Test basic Python libraries"""
    print("üîß Testing Basic Libraries...")
    
    tests = []
    
    try:
        import pandas as pd
        tests.append(("‚úÖ pandas", pd.__version__))
    except ImportError as e:
        tests.append(("‚ùå pandas", f"FAILED: {e}"))
    
    try:
        import numpy as np
        tests.append(("‚úÖ numpy", np.__version__))
    except ImportError as e:
        tests.append(("‚ùå numpy", f"FAILED: {e}"))
    
    try:
        import requests
        tests.append(("‚úÖ requests", requests.__version__))
    except ImportError as e:
        tests.append(("‚ùå requests", f"FAILED: {e}"))
    
    try:
        import fastapi
        tests.append(("‚úÖ fastapi", fastapi.__version__))
    except ImportError as e:
        tests.append(("‚ùå fastapi", f"FAILED: {e}"))
    
    return tests

def test_ml_dependencies():
    """Test ML and optimization libraries"""
    print("ü§ñ Testing ML Dependencies...")
    
    tests = []
    
    try:
        import sklearn
        tests.append(("‚úÖ scikit-learn", sklearn.__version__))
    except ImportError as e:
        tests.append(("‚ùå scikit-learn", f"FAILED: {e}"))
    
    try:
        import xgboost as xgb
        tests.append(("‚úÖ xgboost", xgb.__version__))
    except ImportError as e:
        tests.append(("‚ùå xgboost", f"FAILED: {e}"))
    
    try:
        import tensorflow as tf
        tests.append(("‚úÖ tensorflow", tf.__version__))
    except ImportError as e:
        tests.append(("‚ùå tensorflow", f"FAILED: {e}"))
    
    try:
        from ortools.constraint_solver import pywrapcp
        tests.append(("‚úÖ ortools", "Available"))
    except ImportError as e:
        tests.append(("‚ùå ortools", f"FAILED: {e}"))
    
    try:
        import joblib
        tests.append(("‚úÖ joblib", joblib.__version__))
    except ImportError as e:
        tests.append(("‚ùå joblib", f"FAILED: {e}"))
    
    return tests

def test_backend_modules():
    """Test backend module imports"""
    print("üèóÔ∏è Testing Backend Modules...")
    
    tests = []
    
    try:
        import main
        tests.append(("‚úÖ main.py", "Imported successfully"))
    except Exception as e:
        tests.append(("‚ùå main.py", f"FAILED: {e}"))
    
    try:
        from advanced_ml import TransportMLEnsemble, get_ensemble
        tests.append(("‚úÖ advanced_ml.py", "Imported successfully"))
    except Exception as e:
        tests.append(("‚ùå advanced_ml.py", f"FAILED: {e}"))
    
    try:
        from ghana_economics import get_ghana_economics
        tests.append(("‚úÖ ghana_economics.py", "Imported successfully"))
    except Exception as e:
        tests.append(("‚ùå ghana_economics.py", f"FAILED: {e}"))
    
    try:
        from ortools_optimizer import AccraRouteOptimizer, get_route_optimizer
        tests.append(("‚úÖ ortools_optimizer.py", "Imported successfully"))
    except Exception as e:
        tests.append(("‚ùå ortools_optimizer.py", f"FAILED: {e}"))
    
    try:
        from mapbox_routing import MapboxRoutingPro
        tests.append(("‚úÖ mapbox_routing.py", "Imported successfully"))
    except Exception as e:
        tests.append(("‚ùå mapbox_routing.py", f"FAILED: {e}"))
    
    try:
        import mock_data
        tests.append(("‚úÖ mock_data.py", "Imported successfully"))
    except Exception as e:
        tests.append(("‚ùå mock_data.py", f"FAILED: {e}"))
    
    return tests

def test_ml_functionality():
    """Test ML ensemble functionality"""
    print("üß† Testing ML Functionality...")
    
    tests = []
    
    try:
        from advanced_ml import TransportMLEnsemble
        
        # Test ensemble initialization
        ensemble = TransportMLEnsemble()
        tests.append(("‚úÖ ML Ensemble Init", "Created successfully"))
        
        # Test feature engineering with synthetic data
        import pandas as pd
        test_data = pd.DataFrame({
            'num_stops': [10, 15, 8],
            'hour': [8, 17, 12],
            'day_of_week': [1, 5, 3]
        })
        
        engineered = ensemble.advanced_feature_engineering(test_data)
        tests.append(("‚úÖ Feature Engineering", f"Generated {len(engineered.columns)} features"))
        
        # Test training data preparation
        training_data = ensemble.prepare_training_data()
        tests.append(("‚úÖ Training Data", f"Generated {len(training_data)} samples"))
        
    except Exception as e:
        tests.append(("‚ùå ML Functionality", f"FAILED: {e}"))
        
    return tests

def test_ortools_functionality():
    """Test OR-Tools optimizer functionality"""
    print("üöÄ Testing OR-Tools Functionality...")
    
    tests = []
    
    try:
        from ortools_optimizer import AccraRouteOptimizer
        
        # Test optimizer initialization
        optimizer = AccraRouteOptimizer()
        tests.append(("‚úÖ OR-Tools Init", "Created successfully"))
        
        # Test distance calculation
        lat1, lon1 = 5.6037, -0.1870  # Circle
        lat2, lon2 = 5.5558, -0.2238  # Kaneshie
        
        distance = optimizer.haversine_distance(lat1, lon1, lat2, lon2)
        tests.append(("‚úÖ Distance Calc", f"{distance:.2f} km"))
        
        # Test distance matrix creation
        locations = [(5.6037, -0.1870), (5.5558, -0.2238), (5.6341, -0.1653)]
        matrix = optimizer.create_distance_matrix(locations)
        tests.append(("‚úÖ Distance Matrix", f"{len(matrix)}x{len(matrix[0])} matrix"))
        
        # Test simple route optimization
        demands = [0, 5, 8, 3]  # Depot has 0 demand
        locations_with_depot = [(5.6037, -0.1870), (5.5558, -0.2238), (5.6341, -0.1653), (5.5577, -0.1959)]
        
        result = optimizer.solve_vehicle_routing_problem(locations_with_depot, demands, num_vehicles=2)
        tests.append(("‚úÖ Route Optimization", f"Status: {result.get('status', 'Unknown')}"))
        
    except Exception as e:
        tests.append(("‚ùå OR-Tools Functionality", f"FAILED: {e}"))
        
    return tests

def test_ghana_economics():
    """Test Ghana economics module"""
    print("üá¨üá≠ Testing Ghana Economics...")
    
    tests = []
    
    try:
        from ghana_economics import get_ghana_economics
        
        # Test economics analysis
        test_request = {
            'distance_km': 15.5,
            'num_stops': 12,
            'fuel_efficiency_l_per_100km': 10.0
        }
        
        result = get_ghana_economics().analyze_trip_economics(test_request)
        tests.append(("‚úÖ Economics Analysis", f"Fuel cost: GH‚Çµ{result.get('fuel_cost_ghs', 0):.2f}"))
        
        # Test network economics
        network_result = get_ghana_economics().analyze_network_economics()
        tests.append(("‚úÖ Network Analysis", f"Total routes: {network_result.get('total_routes', 0)}"))
        
    except Exception as e:
        tests.append(("‚ùå Ghana Economics", f"FAILED: {e}"))
        
    return tests

def test_mapbox_integration():
    """Test Mapbox professional routing"""
    print("üó∫Ô∏è Testing Mapbox Integration...")
    
    tests = []
    
    try:
        from mapbox_routing import MapboxRoutingPro
        
        # Test with mock token (won't work but should import)
        mapbox_routing = MapboxRoutingPro("test_token")
        tests.append(("‚úÖ Mapbox Import", "Module imported successfully"))
        
        # Test coordinate validation
        from mapbox_routing import RouteVisualizer
        visualizer = RouteVisualizer()
        tests.append(("‚úÖ Route Visualizer", "Created successfully"))
        
    except Exception as e:
        tests.append(("‚ùå Mapbox Integration", f"FAILED: {e}"))
    
    return tests

def test_data_files():
    """Test GTFS data availability"""
    print("üìä Testing Data Files...")
    
    tests = []
    
    # Check for GTFS data
    gtfs_files = [
        'gtfs-accra-ghana-2016/stops.txt',
        'gtfs-accra-ghana-2016/routes.txt',
        'gtfs-accra-ghana-2016/trips.txt',
        'gtfs-accra-ghana-2016/stop_times.txt'
    ]
    
    for file_path in gtfs_files:
        if os.path.exists(file_path):
            tests.append(("‚úÖ " + file_path, "Found"))
        else:
            tests.append(("‚ö†Ô∏è " + file_path, "Not found (will use synthetic data)"))
    
    # Check for model files
    if os.path.exists('models'):
        tests.append(("‚úÖ models/", "Directory exists"))
    else:
        tests.append(("‚ö†Ô∏è models/", "Directory missing (will be created during training)"))
    
    return tests

def test_api_endpoints():
    """Test FastAPI endpoint structure"""
    print("üåê Testing API Endpoints...")
    
    tests = []
    
    try:
        import main
        app = main.app
        
        # Get route information
        routes = []
        for route in app.routes:
            if hasattr(route, 'path') and hasattr(route, 'methods'):
                routes.append(f"{list(route.methods)[0]} {route.path}")
        
        tests.append(("‚úÖ FastAPI App", f"Created with {len(routes)} endpoints"))
        
        # Test specific endpoints exist
        endpoint_paths = [route.path for route in app.routes if hasattr(route, 'path')]
        
        required_endpoints = [
            '/api/v1/routes',
            '/api/v1/predict/travel_time',
            '/api/v1/predict/ensemble',
            '/api/v1/optimize/routes',
            '/api/v1/live_weather/accra'
        ]
        
        for endpoint in required_endpoints:
            if endpoint in endpoint_paths:
                tests.append(("‚úÖ " + endpoint, "Registered"))
            else:
                tests.append(("‚ùå " + endpoint, "Missing"))
        
    except Exception as e:
        tests.append(("‚ùå API Endpoints", f"FAILED: {e}"))
    
    return tests

def run_comprehensive_test():
    """Run all tests and provide summary"""
    
    print("=" * 60)
    print("üîß COMPREHENSIVE BACKEND TESTING")
    print("üá¨üá≠ Aura Command Pro - Ghana AI Hackathon")
    print("=" * 60)
    
    all_tests = []
    
    # Run all test categories
    test_categories = [
        ("üì¶ Basic Imports", test_basic_imports),
        ("ü§ñ ML Dependencies", test_ml_dependencies),
        ("üèóÔ∏è Backend Modules", test_backend_modules),
        ("üß† ML Functionality", test_ml_functionality),
        ("üöÄ OR-Tools Functionality", test_ortools_functionality),
        ("üá¨üá≠ Ghana Economics", test_ghana_economics),
        ("üó∫Ô∏è Mapbox Integration", test_mapbox_integration),
        ("üìä Data Files", test_data_files),
        ("üåê API Endpoints", test_api_endpoints)
    ]
    
    for category_name, test_function in test_categories:
        print(f"\n{category_name}")
        print("-" * 40)
        
        try:
            tests = test_function()
            all_tests.extend(tests)
            
            for test_name, result in tests:
                print(f"  {test_name}: {result}")
                
        except Exception as e:
            error_test = (f"‚ùå {category_name}", f"Category failed: {e}")
            all_tests.append(error_test)
            print(f"  ‚ùå {category_name}: Category failed: {e}")
    
    # Summary
    print("\n" + "=" * 60)
    print("üìã TEST SUMMARY")
    print("=" * 60)
    
    passed = len([t for t in all_tests if t[0].startswith("‚úÖ")])
    failed = len([t for t in all_tests if t[0].startswith("‚ùå")])
    warnings = len([t for t in all_tests if t[0].startswith("‚ö†Ô∏è")])
    
    print(f"‚úÖ PASSED: {passed}")
    print(f"‚ùå FAILED: {failed}")
    print(f"‚ö†Ô∏è WARNINGS: {warnings}")
    print(f"üìä TOTAL: {len(all_tests)}")
    
    # Overall status
    if failed == 0:
        print("\nüéâ ALL TESTS PASSED! Backend is ready for production!")
        print("üöÄ Ready for hackathon demo!")
    elif failed <= 2:
        print("\n‚ö†Ô∏è Minor issues detected but system should work")
        print("üîß Consider fixing failed tests for optimal performance")
    else:
        print("\n‚ùå Multiple issues detected")
        print("üîß Please fix failed tests before demo")
    
    # Failed tests details
    if failed > 0:
        print("\nüîç FAILED TESTS DETAILS:")
        for test_name, result in all_tests:
            if test_name.startswith("‚ùå"):
                print(f"  {test_name}: {result}")
    
    print(f"\nüïí Test completed at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 60)
    
    return passed, failed, warnings

if __name__ == "__main__":
    try:
        passed, failed, warnings = run_comprehensive_test()
        
        # Exit with appropriate code
        if failed == 0:
            sys.exit(0)  # Success
        else:
            sys.exit(1)  # Some failures
            
    except Exception as e:
        print(f"\nüí• CRITICAL ERROR during testing: {e}")
        print("\nFull traceback:")
        traceback.print_exc()
        sys.exit(2)  # Critical failure 